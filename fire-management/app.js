// app.js - Logic ch√≠nh c·ªßa ·ª©ng d·ª•ng
class FireManagementSystem {
  constructor() {
    this.map = null;
    this.currentMarkers = [];
    this.filteredData = [...fireData];
    this.dangerLevelChart = null;
    this.districtChart = null;
    this.newsChart = null;

    this.init();
  }

  init() {
    this.initializeMap();
    this.initializeEventListeners();
    this.displayFiresOnMap();
    this.updateStatistics();
    this.initializeCharts();
  }

  initializeMap() {
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    this.map = L.map("map").setView(mapConfig.center, mapConfig.zoom);

    // Th√™m tile layer
    L.tileLayer(mapConfig.tileLayer, {
      attribution: mapConfig.attribution,
    }).addTo(this.map);
  }

  initializeEventListeners() {
    // Th√™m s·ª± ki·ªán cho c√°c n√∫t
    document
      .getElementById("addFireBtn")
      .addEventListener("click", () => this.addNewFire());
    document
      .getElementById("searchBtn")
      .addEventListener("click", () => this.searchFiresByTime());
    document
      .getElementById("resetSearchBtn")
      .addEventListener("click", () => this.resetSearch());
    document
      .getElementById("filterDistrict")
      .addEventListener("change", (e) => this.filterByDistrict(e.target.value));
    document
      .getElementById("filterDangerLevel")
      .addEventListener("change", (e) =>
        this.filterByDangerLevel(e.target.value)
      );

    // T·ª± ƒë·ªông l·∫•y th·ªùi gian hi·ªán t·∫°i cho form th√™m m·ªõi
    document.getElementById("discoveryTime").value = this.getCurrentDateTime();

    // Th√™m s·ª± ki·ªán cho form th√™m ƒëi·ªÉm ch√°y - tr∆∞·ªùng newsUrl
    document
      .getElementById("newsUrl")
      .addEventListener("change", (e) => this.validateUrl(e.target));
  }

  validateUrl(input) {
    const url = input.value;
    if (url && !this.isValidUrl(url)) {
      input.style.borderColor = "red";
      document.getElementById("urlError").style.display = "block";
    } else {
      input.style.borderColor = "#ddd";
      document.getElementById("urlError").style.display = "none";
    }
  }

  isValidUrl(string) {
    try {
      new URL(string);
      return true;
    } catch (_) {
      return false;
    }
  }

  getCurrentDateTime() {
    const now = new Date();
    return now.toISOString().slice(0, 16);
  }

  displayFiresOnMap(fires = this.filteredData) {
    // X√≥a c√°c marker c≈©
    this.currentMarkers.forEach((marker) => this.map.removeLayer(marker));
    this.currentMarkers = [];

    // Th√™m marker m·ªõi
    fires.forEach((fire) => {
      const markerColor = this.getColorByDangerLevel(fire.dangerLevel);

      const marker = L.circleMarker(fire.coordinates, {
        color: markerColor,
        fillColor: markerColor,
        fillOpacity: 0.7,
        radius: Math.min(Math.sqrt(fire.affectedArea) * 2, 20),
      }).addTo(this.map);

      // Th√™m popup th√¥ng tin chi ti·∫øt
      marker.bindPopup(this.createFirePopupContent(fire));

      // Th√™m tooltip t√πy ch·ªânh khi hover
      marker.bindTooltip(this.createFireTooltip(fire), {
        permanent: false,
        direction: "top",
        className: "custom-tooltip",
        offset: [0, -10],
      });

      // Th√™m s·ª± ki·ªán click ƒë·ªÉ m·ªü b√°o ch√≠
      if (fire.newsUrl) {
        marker.on("click", () => {
          // M·ªü trang b√°o trong tab m·ªõi khi click v√†o marker
          window.open(fire.newsUrl, "_blank");
        });
      }

      this.currentMarkers.push(marker);
    });
  }

  createFireTooltip(fire) {
    const dangerClass = `danger-${fire.dangerLevel}`;
    const newsInfo = fire.newsUrl
      ? '<div class="tooltip-news">üì∞ Click ƒë·ªÉ ƒë·ªçc b√°o</div>'
      : "";

    return `
            <div class="tooltip-title">${fire.name}</div>
            <div class="tooltip-info">
                <span class="tooltip-label">ƒê·ªãa ƒëi·ªÉm:</span> ${fire.district}
            </div>
            <div class="tooltip-info">
                <span class="tooltip-label">Th·ªùi gian:</span> ${this.formatDateTime(
                  fire.discoveryTime
                )}
            </div>
            <div class="tooltip-info">
                <span class="tooltip-label">M·ª©c ƒë·ªô:</span> 
                <span class="${dangerClass}">${this.getDangerLevelText(
      fire.dangerLevel
    )}</span>
            </div>
            <div class="tooltip-info">
                <span class="tooltip-label">Di·ªán t√≠ch:</span> ${
                  fire.affectedArea
                } ha
            </div>
            <div class="tooltip-info">
                <span class="tooltip-label">Tr·∫°ng th√°i:</span> ${
                  fire.status === "active"
                    ? "üî• ƒêang ho·∫°t ƒë·ªông"
                    : "‚úÖ ƒê√£ d·∫≠p t·∫Øt"
                }
            </div>
            <div class="tooltip-info">
                <span class="tooltip-label">Nguy√™n nh√¢n:</span> ${
                  fire.cause || "ƒêang ƒëi·ªÅu tra"
                }
            </div>
            ${newsInfo}
        `;
  }

  createFirePopupContent(fire) {
    const dangerClass = `danger-${fire.dangerLevel}`;
    const newsButton = fire.newsUrl
      ? `<a href="${fire.newsUrl}" target="_blank" class="news-btn" onclick="event.stopPropagation()">
                <i class="fas fa-newspaper"></i> üì∞ ƒê·ªçc b√°o v·ªÅ v·ª• ch√°y
            </a>`
      : '<div class="no-news">Ch∆∞a c√≥ th√¥ng tin b√°o ch√≠</div>';

    return `
            <div class="fire-popup">
                <div class="popup-header">
                    <h3><i class="fas fa-fire"></i> ${fire.name}</h3>
                </div>
                <div class="popup-content">
                    <div class="popup-info">
                        <span class="popup-label">ƒê·ªãa ƒëi·ªÉm:</span> ${
                          fire.district
                        }
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">Th·ªùi gian:</span> ${this.formatDateTime(
                          fire.discoveryTime
                        )}
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">M·ª©c ƒë·ªô:</span> 
                        <span class="${dangerClass}">${this.getDangerLevelText(
      fire.dangerLevel
    )}</span>
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">Di·ªán t√≠ch:</span> ${
                          fire.affectedArea
                        } ha
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">Tr·∫°ng th√°i:</span> ${
                          fire.status === "active"
                            ? "üî• ƒêang ho·∫°t ƒë·ªông"
                            : "‚úÖ ƒê√£ d·∫≠p t·∫Øt"
                        }
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">Nguy√™n nh√¢n:</span> ${
                          fire.cause || "ƒêang ƒëi·ªÅu tra"
                        }
                    </div>
                    <div class="news-section">
                        ${newsButton}
                    </div>
                </div>
            </div>
        `;
  }

  getColorByDangerLevel(level) {
    return dangerLevels[level]?.color || "gray";
  }

  getDangerLevelText(level) {
    return dangerLevels[level]?.text || "Kh√¥ng x√°c ƒë·ªãnh";
  }

  formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleString("vi-VN");
  }

  addNewFire() {
    const name = document.getElementById("fireName").value;
    const lat = parseFloat(document.getElementById("fireLat").value);
    const lng = parseFloat(document.getElementById("fireLng").value);
    const discoveryTime = document.getElementById("discoveryTime").value;
    const dangerLevel = document.getElementById("dangerLevel").value;
    const affectedArea = parseFloat(
      document.getElementById("affectedArea").value
    );
    const district = document.getElementById("fireDistrict").value;
    const cause = document.getElementById("fireCause").value;
    const newsUrl = document.getElementById("newsUrl").value;

    if (
      !this.validateFireInput(
        name,
        lat,
        lng,
        discoveryTime,
        affectedArea,
        district
      )
    ) {
      alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
      return;
    }

    if (newsUrl && !this.isValidUrl(newsUrl)) {
      alert("URL b√°o ch√≠ kh√¥ng h·ª£p l·ªá!");
      return;
    }

    const newFire = {
      id: fireData.length + 1,
      name: name,
      coordinates: [lat, lng],
      discoveryTime: discoveryTime + ":00",
      dangerLevel: dangerLevel,
      affectedArea: affectedArea,
      province: "An Giang",
      status: "active",
      district: district,
      cause: cause,
      newsUrl: newsUrl,
    };

    fireData.push(newFire);
    this.filteredData = [...fireData];
    this.displayFiresOnMap();
    this.updateStatistics();
    this.updateCharts();
    this.resetForm();

    alert("ƒê√£ th√™m ƒëi·ªÉm ch√°y m·ªõi!");
  }

  validateFireInput(name, lat, lng, discoveryTime, affectedArea, district) {
    return name && lat && lng && discoveryTime && affectedArea && district;
  }

  resetForm() {
    document.getElementById("fireName").value = "";
    document.getElementById("fireLat").value = "";
    document.getElementById("fireLng").value = "";
    document.getElementById("discoveryTime").value = this.getCurrentDateTime();
    document.getElementById("affectedArea").value = "";
    document.getElementById("fireDistrict").value = "";
    document.getElementById("fireCause").value = "";
    document.getElementById("newsUrl").value = "";
    document.getElementById("urlError").style.display = "none";
  }

  searchFiresByTime() {
    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;

    if (!startTime || !endTime) {
      alert("Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian!");
      return;
    }

    const start = new Date(startTime);
    const end = new Date(endTime);

    this.filteredData = fireData.filter((fire) => {
      const fireTime = new Date(fire.discoveryTime);
      return fireTime >= start && fireTime <= end;
    });

    this.displayFiresOnMap();
    this.updateStatistics();
    this.updateCharts();
  }

  filterByDistrict(district) {
    if (!district) {
      this.filteredData = [...fireData];
    } else {
      this.filteredData = fireData.filter((fire) => fire.district === district);
    }
    this.displayFiresOnMap();
    this.updateStatistics();
    this.updateCharts();
  }

  filterByDangerLevel(level) {
    if (!level) {
      this.filteredData = [...fireData];
    } else {
      this.filteredData = fireData.filter((fire) => fire.dangerLevel === level);
    }
    this.displayFiresOnMap();
    this.updateStatistics();
    this.updateCharts();
  }

  resetSearch() {
    document.getElementById("startTime").value = "";
    document.getElementById("endTime").value = "";
    document.getElementById("filterDistrict").value = "";
    document.getElementById("filterDangerLevel").value = "";

    this.filteredData = [...fireData];
    this.displayFiresOnMap();
    this.updateStatistics();
    this.updateCharts();
  }

  updateStatistics(fires = this.filteredData) {
    const totalFires = fires.length;
    const activeFires = fires.filter((fire) => fire.status === "active").length;
    const totalArea = fires.reduce((sum, fire) => sum + fire.affectedArea, 0);
    const firesWithNews = fires.filter((fire) => fire.newsUrl).length;

    document.getElementById("totalFires").textContent = totalFires;
    document.getElementById("activeFires").textContent = activeFires;
    document.getElementById("totalArea").textContent = totalArea.toFixed(2);
    document.getElementById("firesWithNews").textContent = firesWithNews;
  }

  initializeCharts() {
    this.createDangerLevelChart();
    this.createDistrictChart();
    this.createNewsChart();
  }

  createDangerLevelChart() {
    const ctx = document.getElementById("dangerLevelChart").getContext("2d");
    const dangerCounts = this.countByDangerLevel();

    this.dangerLevelChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Th·∫•p", "Trung b√¨nh", "Cao"],
        datasets: [
          {
            data: [dangerCounts.low, dangerCounts.medium, dangerCounts.high],
            backgroundColor: ["#27ae60", "#f39c12", "#e74c3c"],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: "Ph√¢n b·ªë theo m·ª©c ƒë·ªô nguy hi·ªÉm",
            color: "#ecf0f1",
            font: {
              size: 14,
            },
          },
          legend: {
            labels: {
              color: "#ecf0f1",
            },
          },
        },
      },
    });
  }

  createDistrictChart() {
    const ctx = document.getElementById("districtChart").getContext("2d");
    const districtData = this.countFiresByDistrict();

    this.districtChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(districtData),
        datasets: [
          {
            label: "S·ªë v·ª• ch√°y",
            data: Object.values(districtData),
            backgroundColor: "rgba(52, 152, 219, 0.8)",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: "S·ªë v·ª• ch√°y theo huy·ªán",
            color: "#ecf0f1",
            font: {
              size: 14,
            },
          },
          legend: {
            labels: {
              color: "#ecf0f1",
            },
          },
        },
        scales: {
          x: {
            ticks: {
              color: "#ecf0f1",
            },
            grid: {
              color: "rgba(255, 255, 255, 0.1)",
            },
          },
          y: {
            ticks: {
              color: "#ecf0f1",
            },
            grid: {
              color: "rgba(255, 255, 255, 0.1)",
            },
          },
        },
      },
    });
  }

  createNewsChart() {
    const ctx = document.getElementById("newsChart").getContext("2d");
    const newsData = this.countFiresWithNews();

    this.newsChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["C√≥ th√¥ng tin b√°o ch√≠", "Ch∆∞a c√≥ th√¥ng tin"],
        datasets: [
          {
            data: [newsData.withNews, newsData.withoutNews],
            backgroundColor: ["#3498db", "#95a5a6"],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: "Th√¥ng tin b√°o ch√≠",
            color: "#ecf0f1",
            font: {
              size: 14,
            },
          },
          legend: {
            labels: {
              color: "#ecf0f1",
            },
          },
        },
      },
    });
  }

  countByDangerLevel() {
    return {
      low: this.filteredData.filter((fire) => fire.dangerLevel === "low")
        .length,
      medium: this.filteredData.filter((fire) => fire.dangerLevel === "medium")
        .length,
      high: this.filteredData.filter((fire) => fire.dangerLevel === "high")
        .length,
    };
  }

  countFiresByDistrict() {
    const districtCounts = {};
    districts.forEach((district) => {
      districtCounts[district] = this.filteredData.filter(
        (fire) => fire.district === district
      ).length;
    });
    return districtCounts;
  }

  countFiresWithNews() {
    const fires = this.filteredData;
    return {
      withNews: fires.filter((fire) => fire.newsUrl).length,
      withoutNews: fires.filter((fire) => !fire.newsUrl).length,
    };
  }

  updateCharts() {
    const dangerCounts = this.countByDangerLevel();
    const districtData = this.countFiresByDistrict();
    const newsData = this.countFiresWithNews();

    if (this.dangerLevelChart) {
      this.dangerLevelChart.data.datasets[0].data = [
        dangerCounts.low,
        dangerCounts.medium,
        dangerCounts.high,
      ];
      this.dangerLevelChart.update();
    }

    if (this.districtChart) {
      this.districtChart.data.labels = Object.keys(districtData);
      this.districtChart.data.datasets[0].data = Object.values(districtData);
      this.districtChart.update();
    }

    if (this.newsChart) {
      this.newsChart.data.datasets[0].data = [
        newsData.withNews,
        newsData.withoutNews,
      ];
      this.newsChart.update();
    }
  }
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi trang ƒë√£ t·∫£i xong
document.addEventListener("DOMContentLoaded", () => {
  new FireManagementSystem();
});
